# SSLcat v1.0.13 集群架构功能说明

## 📋 功能概述

SSLcat v1.0.13 引入了完整的 Master-Slave 集群架构，支持多节点部署、配置同步和集中管理，大幅提升了系统的高可用性和运维效率。

## 🌐 核心特性

### 1. 三种运行模式

#### 🔄 Standalone（独立模式）
- **默认模式**：单节点独立运行
- **适用场景**：小型部署、开发测试环境
- **特点**：所有功能完整可用，不依赖其他节点

#### 👑 Master（主节点模式）
- **集群控制器**：管理整个集群的配置和状态
- **适用场景**：多节点部署的主控节点
- **特点**：
  - 提供配置同步服务
  - 管理集群节点状态
  - 处理 Slave 节点的同步请求

#### 🔗 Slave（从节点模式）
- **受控节点**：从 Master 节点同步配置和证书
- **适用场景**：分布式部署的从属节点
- **功能限制**：
  - ✅ 可修改管理员密码
  - ✅ 可修改管理面板路径
  - ✅ 可解除 Slave 模式
  - ✅ 可查看集群状态
  - ❌ 不可修改代理规则
  - ❌ 不可管理 SSL 证书
  - ❌ 不可修改安全设置

### 2. 自动同步机制

#### 配置同步
- **实时同步**：Master 配置变更后自动推送到 Slave
- **增量更新**：只同步变更的配置项，提高效率
- **排除机制**：管理员密码、面板路径等敏感配置不同步

#### 证书同步
- **SSL 证书共享**：Master 申请的证书自动分发到 Slave
- **私钥安全传输**：使用加密通道传输敏感文件
- **自动更新**：证书续期后自动同步到所有节点

#### 同步策略
- **定时同步**：默认每 30 秒同步一次
- **故障重试**：连接失败时自动重试
- **超时控制**：避免长时间阻塞

### 3. 集群管理界面

#### 节点状态监控
- **实时状态**：显示所有节点的在线状态
- **节点信息**：节点 ID、名称、模式、地址
- **通信状态**：最后通信时间、同步状态

#### 模式切换
- **一键切换**：通过 Web 界面轻松切换节点模式
- **参数配置**：Master 地址、端口、认证密钥
- **状态验证**：切换前验证连接有效性

## 🛠️ 技术实现

### 配置结构
```json
{
  "cluster": {
    "mode": "standalone|master|slave",
    "node_id": "自动生成的唯一标识",
    "node_name": "节点名称",
    "master": {
      "host": "Master节点地址",
      "port": 8443,
      "auth_key": "认证密钥",
      "timeout": 30,
      "retry_interval": 10
    },
    "sync": {
      "config_enabled": true,
      "cert_enabled": true,
      "interval": 30,
      "timeout": 10,
      "exclude_configs": [
        "admin.password",
        "admin.password_file",
        "admin_prefix",
        "cluster"
      ]
    },
    "port": 8443,
    "auth_key": "集群通信密钥"
  }
}
```

### 核心组件

#### ClusterManager（集群管理器）
- **功能**：管理集群状态、处理同步请求
- **接口**：Start/Stop、模式切换、节点管理
- **同步逻辑**：配置拉取、证书同步、状态更新

#### 权限控制中间件
- **requireNonSlaveMode**：限制 Slave 模式下的操作
- **isSlaveAllowedAction**：检查操作权限
- **动态界面调整**：根据模式显示/隐藏功能

#### 同步API
- **POST /cluster/sync**：Slave 向 Master 请求同步
- **认证机制**：基于共享密钥的身份验证
- **数据格式**：JSON 格式的配置和证书数据

## 🚀 使用指南

### 部署 Master-Slave 集群

#### 1. 设置 Master 节点
```bash
# 1. 启动 Master 节点（默认为 standalone 模式）
./sslcat -config master.conf

# 2. 通过 Web 界面设置为 Master 模式（将在后续版本中实现）
# 或者直接编辑配置文件
```

#### 2. 配置 Slave 节点
```bash
# 1. 启动 Slave 节点
./sslcat -config slave.conf

# 2. 访问管理面板：http://slave-ip/sslcat-panel
# 3. 进入集群设置页面
# 4. 填写 Master 信息：
#    - Master 地址：192.168.1.100
#    - Master 端口：8443  
#    - 认证密钥：shared-secret-key
# 5. 点击"设置为 Slave 模式"
```

#### 3. 验证集群状态
- 在任意节点的管理面板查看集群节点列表
- 确认所有节点状态为"在线"
- 验证配置同步是否正常工作

### 故障恢复

#### Slave 节点离线
- **自动重连**：Slave 节点会自动尝试重新连接 Master
- **配置保持**：离线期间配置保持不变
- **重新同步**：恢复连接后自动拉取最新配置

#### Master 节点故障
- **解除 Slave 模式**：在任意 Slave 节点上解除 Slave 模式
- **升级为 Master**：将某个 Slave 节点设置为新的 Master
- **重新配置集群**：其他节点重新连接到新 Master

## 📊 使用场景

### 1. 多机房部署
```
机房A (Master)     机房B (Slave)      机房C (Slave)
     |                  |                  |
   配置管理          自动同步           自动同步
     |                  |                  |
   证书申请          证书分发           证书分发
```

### 2. 负载均衡部署
```
       Load Balancer
            |
    +-------+-------+
    |       |       |
 Node1   Node2   Node3
(Master) (Slave) (Slave)
```

### 3. 容灾备份
```
主站点 (Master)  →  备份站点 (Slave)
     |                    |
   正常服务            热备待机
     |                    |
   配置同步  →→→→→→→→→  自动应用
```

## 🔧 配置示例

### Master 节点配置
```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 443
  },
  "cluster": {
    "mode": "master",
    "node_id": "master-001",
    "node_name": "主控节点",
    "port": 8443,
    "auth_key": "your-secret-key-here"
  }
}
```

### Slave 节点配置
```json
{
  "server": {
    "host": "0.0.0.0", 
    "port": 443
  },
  "cluster": {
    "mode": "slave",
    "node_id": "slave-001",
    "node_name": "从节点1",
    "master": {
      "host": "192.168.1.100",
      "port": 8443,
      "auth_key": "your-secret-key-here",
      "timeout": 30,
      "retry_interval": 10
    },
    "sync": {
      "config_enabled": true,
      "cert_enabled": true,
      "interval": 30
    }
  }
}
```

## 🔒 安全考虑

### 认证机制
- **共享密钥**：所有节点使用相同的认证密钥
- **传输加密**：TODO: 实现 TLS 加密通信
- **权限隔离**：Slave 节点严格限制可修改的配置

### 网络安全
- **内网通信**：建议在内网环境中部署集群
- **防火墙配置**：开放必要的集群通信端口
- **访问控制**：限制集群管理端口的访问来源

## 📈 性能优化

### 同步优化
- **增量同步**：只传输变更的配置项
- **压缩传输**：大文件使用压缩算法
- **异步处理**：避免同步操作阻塞主服务

### 资源管理
- **连接池**：复用 HTTP 连接减少开销
- **超时控制**：避免长时间等待
- **内存管理**：及时清理过期的节点信息

## 🐛 故障排除

### 常见问题

#### 1. Slave 节点无法连接 Master
**现象**：Slave 节点显示连接失败
**排查步骤**：
1. 检查 Master 节点是否正常运行
2. 验证网络连通性（ping、telnet）
3. 确认端口是否开放
4. 检查认证密钥是否正确

#### 2. 配置同步失败
**现象**：Master 配置变更后 Slave 未更新
**排查步骤**：
1. 查看 Slave 节点日志
2. 检查同步间隔设置
3. 验证 Master 节点同步服务状态
4. 手动触发同步测试

#### 3. 证书同步问题
**现象**：SSL 证书未同步到 Slave
**排查步骤**：
1. 检查证书文件权限
2. 验证存储路径是否正确
3. 查看传输日志
4. 确认证书格式是否支持

### 日志分析
```bash
# 查看集群相关日志
tail -f sslcat.log | grep cluster

# 查看同步状态
tail -f sslcat.log | grep sync
```

## 🔮 后续规划

### v1.0.14 计划
- **TLS 加密通信**：集群节点间通信加密
- **配置冲突检测**：检测并解决配置冲突
- **集群健康检查**：节点健康状态监控
- **自动故障切换**：Master 故障时自动选举新 Master

### v1.1.x 计划
- **Web UI 集群管理**：完整的集群管理界面
- **节点负载均衡**：智能分配请求到不同节点
- **配置版本控制**：支持配置回滚和版本管理
- **监控告警集成**：集群状态监控和告警

---

**文档版本**: v1.0  
**更新日期**: 2025-01-03  
**适用版本**: SSLcat v1.0.13+
