## 无第三方人机验证（PoW + 蜜罐 + 最小填写时长）技术实现

### 背景与目标
- **目标**: 在不依赖第三方服务的前提下，提高管理面板登录的人机区分能力，降低脚本/机器人暴力尝试与批量撞库的成功率，同时兼顾用户体验与易集成。
- **方案**: 叠加式防护链路：客户端工作量证明（Proof of Work，PoW）+ 蜜罐输入 + 最小填写时长阈值，再与现有图形验证码组合使用。

### 架构概览
- **后端组件**：
  - `internal/web/pow.go`：`PowManager` 负责 PoW 挑战的生成、一次性校验与过期清理。
  - `internal/web/handlers.go`：登录 GET/POST 流程接入蜜罐、最小时长和 PoW 校验逻辑。
  - `internal/web/server.go`：在服务器初始化时实例化 `powManager`。
  - `internal/web/api.go`：图形验证码 API 与绘制（现有能力，和本方案叠加）。
- **前端模板**：
  - `internal/assets/templates/login.html`：
    - 注入隐藏字段：`pow_nonce`、`pow_solution`、`form_start_ts`、随机蜜罐字段。
    - 使用 WebCrypto 执行 SHA-256 计算，求解 PoW 后再提交登录表单。

### 时序与流程
1. 浏览器 GET `{{AdminPrefix}}/login`
   - 服务器通过 `PowManager.Issue()` 生成随机 `nonce` 与难度 `bits`，并生成随机蜜罐字段名（例如 `hp_ab12cd`）与 `form_start_ts`（毫秒）。
   - 将以上信息以模板变量形式注入到 `login.html`。
   - 同时前端首次拉取图形验证码图片（保留现有能力）。
2. 用户点击“登录”时（前端提交前）
   - 前端 JS 使用 WebCrypto 计算 `SHA-256(nonce + ":" + solution)`，寻找满足“前导零比特数 ≥ bits”的 `solution`，写入隐藏域 `pow_solution` 后再提交表单。
3. 服务器接收 POST `{{AdminPrefix}}/login`
   - 先校验：
     - **蜜罐输入**：任何以 `hp_` 开头的字段若被填写，直接拒绝。
     - **最小填写时长**：`now - form_start_ts` < 800ms 时直接拒绝。
     - **PoW**：校验 `pow_nonce` 与 `pow_solution` 一次性通过（前导零比特数 ≥ bits、未过期、未重复使用）。
     - **图形验证码**：完成上述后再校验图片验证码。
   - 通过以上校验后，进入原有 `processLogin` 逻辑进行用户名/密码验证与登录。

### 前后端字段
- **GET 注入（模板变量）**：
  - `PowNonce`（字符串）：PoW 随机挑战值。
  - `PowBits`（整型）：目标前导零比特数（默认 18）。
  - `HoneypotName`（字符串）：随机蜜罐字段名，例如 `hp_c3f0a1`。
  - `FormStartTs`（整型毫秒时间戳）：页面渲染时刻。
- **POST 提交（表单字段）**：
  - `pow_nonce`、`pow_solution`、`form_start_ts`、`<honeypotName>`（由 GET 时动态注入的字段名）。
  - 以及既有 `username`、`password`、`captcha_session_id`、`captcha_text` 等。

### 关键代码位置
- `internal/web/pow.go`
  - `PowManager`：
    - `Issue(ip string) (nonce string, bits int)`：创建挑战并记录会话（一次性、带 TTL）。
    - `Verify(nonce, solution string) bool`：校验后即删除会话。
    - `leadingZeroBits(b []byte) int`：计算哈希的前导零比特数。
- `internal/web/server.go`
  - 在 `NewServer` 中初始化：`server.powManager = NewPowManager()`。
- `internal/web/handlers.go`
  - `handleLogin`：
    - GET：下发 `PowNonce`、`PowBits`、`HoneypotName`、`FormStartTs`；渲染登录模板。
    - POST：依次校验蜜罐、最小时长、PoW、图片验证码，失败则回填新的挑战并提示。
- `internal/assets/templates/login.html`
  - 隐藏域注入：`pow_nonce`、`pow_solution`、`form_start_ts`、蜜罐字段。
  - JS：计算 `sha256(nonce+":"+solution)` 直至满足目标 `bits`，再提交表单。
- `internal/web/api.go`
  - 图形验证码 API 与绘制：与 PoW 并行叠加使用，提升整体拦截强度。

### PoW 细节说明
- **难度（Bits）**：默认 18，比特数越大，所需尝试次数期望为 \(2^{bits-1}\)；在现代桌面端通常 0.1–0.4 秒，低端移动设备可能更久。
- **哈希**：`SHA-256(nonce + ":" + solution)`；校验前导零比特数 ≥ `bits`。
- **一次性与过期**：
  - `nonce` 对应的会话在服务端缓存，`Verify` 通过后立即删除，防止重放。
  - 默认 TTL：2 分钟，过期挑战无效。

### 参数与默认值（后端）
- `PowManager.defaultBits = 18`
- `PowManager.ttl = 2 * time.Minute`
- 登录最小填写时长阈值：`800ms`

### 安全性与对抗性
- **抗脚本**：PoW 使每次提交具有显著计算成本；蜜罐可识别“盲填/全填”型脚本；最小时长阈值阻止闪电提交。
- **重放防护**：PoW 挑战一次性、短期有效；验证码会话亦一次性。
- **信息最小化**：服务器不回显 PoW 内部细节；失败仅提示通用错误，降低对手调参效率。
- **组合防护**：与现有图形验证码叠加，兼顾“计算成本 + 视觉挑战”。

### 性能与资源
- **后端**：主要为常量级哈希校验与内存 Map 查找；GC loop 每分钟清理过期会话，资源占用低。
- **前端**：PoW 计算时间与设备性能相关；已在循环中加入 `setTimeout(0)` 让步，避免长时间 UI 卡顿。

### 常见失败与回退逻辑
- 蜜罐被触发、填写过快、PoW 校验失败、验证码错误：均拒绝并回填新的 `nonce/bits/蜜罐`，提示用户重试。
- 若低端设备体验不佳，可降低 `bits`（如 16–17），或按 IP/失败次数自适应调参（见“扩展方向”）。

### 监控与日志
- 现已记录登录成功/失败审计与访问日志；如需针对 PoW 单独统计，可在 `Verify` 结果处计数（建议仅记聚合指标，避免敏感细节外泄）。

### 未来扩展方向
- **自适应难度**：按 IP、UA、失败次数或地理区域动态调整 `bits`。
- **行为评分**：加入键盘/焦点等非侵入行为信号，综合评分触发更高防护级别。
- **与速率限制联动**：失败频繁时提高难度或临时封禁。
- **多因素**：为管理后台引入 TOTP 二次验证（`github.com/pquerna/otp/totp`）。
- **策略开关**：将 `bits`、最小时长阈值等暴露到配置文件中，便于运维调优。

### 测试要点
- **功能流转**：
  - 正常用户：能在合理时间（<1s）内完成 PoW 并登录。
  - 失败场景：分别触发蜜罐、过快提交、PoW 错误、验证码错误，均得到拒绝与新挑战。
- **跨端覆盖**：桌面端与移动端（低端机）体验与耗时评估，必要时调整 `bits`。
- **对抗性**：模拟脚本绕过尝试（不计算 PoW/不等待时长/盲填蜜罐）应全部失败。

---

### 变更清单（供追溯）
- 新增：`internal/web/pow.go`
- 修改：`internal/web/server.go`（初始化 `powManager`）
- 修改：`internal/web/handlers.go`（登录 GET/POST 接入 PoW/蜜罐/最小时长）
- 修改：`internal/assets/templates/login.html`（隐藏字段与前端 WebCrypto 计算）
- 现有：`internal/web/api.go`（图形验证码 API 与图片绘制）
